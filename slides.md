---
# try also 'default' to start simple
theme: seriph
# random image from a curated Unsplash collection by Anthony
# like them? see https://unsplash.com/collections/94734566/slidev
background: https://source.unsplash.com/collection/94734566/1920x1080
# apply any windi css classes to the current slide
class: "text-center"
# https://sli.dev/custom/highlighters.html
highlighter: shiki
# show line numbers in code blocks
lineNumbers: true
# some information about the slides, markdown enabled
info: |
  ## Slidev Starter Template
  Presentation slides for developers.

  Learn more at [Sli.dev](https://sli.dev)
# persist drawings in exports and build
drawings:
  persist: false
---

# V8 in Browser

[@zhang13pro](https://github.com/zhang13pro)

<div class="pt-12">
  <span @click="$slidev.nav.next" class="px-2 py-1 rounded cursor-pointer" hover="bg-white bg-opacity-10">
    Next() <carbon:arrow-right class="inline"/>
  </span>
</div>

<div class="abs-br m-6 flex gap-2">
  <button @click="$slidev.nav.openInEditor()" title="Open in Editor" class="text-xl icon-btn opacity-50 !border-none !hover:text-white">
    <carbon:edit />
  </button>
  <a href="https://github.com/zhang13pro/presentation-v8" target="_blank" alt="GitHub"
    class="text-xl icon-btn opacity-50 !border-none !hover:text-white">
    <carbon-logo-github />
  </a>
</div>

<!--
The last comment block of each slide will be treated as slide notes. It will be visible and editable in Presenter Mode along with the slide. [Read more in the docs](https://sli.dev/guide/syntax.html#notes)
-->

---

# V8 æ€ä¹ˆè¿è¡Œ JavaScript ä»£ç 

<v-clicks>

```mermaid { scale: 0.8}
flowchart LR
    åˆå§‹åŒ–åŸºç¡€ç¯å¢ƒ-- è§£æå™¨parse --- ASTå’Œä½œç”¨åŸŸ
    -- è§£é‡Šå™¨ --- ç”Ÿæˆå­—èŠ‚ç -- è§£é‡Šå™¨ --- è§£é‡Šæ‰§è¡Œå­—èŠ‚ç  -- ç›‘å¬,ä¼˜åŒ–çƒ­ç‚¹ä»£ç 
    --- äºŒè¿›åˆ¶ä»£ç  -- åä¼˜åŒ– --- è§£é‡Šæ‰§è¡Œå­—èŠ‚ç 
```

### å‡½æ•°çš„æœ¬è´¨

å‡½æ•°æ˜¯ç‰¹æ®Šçš„å¯¹è±¡

éšè—å±æ€§

- name
- code
- prototype
- [[prototype]]

</v-clicks>

<!-- å¦‚æœæŸä¸ªç¼–ç¨‹è¯­è¨€çš„å‡½æ•°å¯ä»¥å’Œå®ƒçš„æ•°æ®ç±»å‹åšä¸€æ ·çš„äº‹æƒ…ï¼Œæˆ‘ä»¬å°±æŠŠè¿™ä¸ªè¯­è¨€ä¸­çš„å‡½æ•°ç§°ä¸ºä¸€ç­‰å…¬æ°‘ã€‚

JavaScript ä¸­çš„å¯¹è±¡å°±æ˜¯ç”±ä¸€ç»„ä¸€ç»„å±æ€§å’Œå€¼ç»„æˆçš„é›†åˆï¼Œæ—¢ç„¶å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼Œé‚£ä¹ˆå‡½æ•°ä¹Ÿæ˜¯ç”±ä¸€ç»„ç»„å€¼å’Œå±æ€§ç»„æˆçš„é›†åˆ

å‡½æ•°ä¹‹æ‰€ä»¥æˆä¸ºç‰¹æ®Šçš„å¯¹è±¡ï¼Œè¿™ä¸ªç‰¹æ®Šçš„åœ°æ–¹æ˜¯å‡½æ•°å¯ä»¥â€œè¢«è°ƒç”¨â€ï¼Œæ‰€ä»¥ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œå®ƒè¿˜éœ€è¦å…³è”ç›¸å…³çš„æ‰§è¡Œä¸Šä¸‹æ–‡ã€‚
-->

---

# åœ¨ V8 ä¸­è®¿é—®å¯¹è±¡å±æ€§

å¸¸è§„å±æ€§ (properties) å’Œæ’åºå±æ€§ (element)

```js
function Foo() {
  this[100] = "test-100";
  this[1] = "test-1";
  this["B"] = "bar-B";
  this[50] = "test-50";
  this[9] = "test-9";
  this[8] = "test-8";
  this[3] = "test-3";
  this[5] = "test-5";
  this["A"] = "bar-A";
  this["C"] = "bar-C";
}
var bar = new Foo();
for (key in bar) {
  console.log(`index:${key} value:${bar[key]}`);
}
```

<v-click>

æŸ¥æ‰¾è¿‡ç¨‹å°†å¤šä¸€æ­¥æ“ä½œ

</v-click>

<!--
æ•°å­—å±æ€§åº”è¯¥æŒ‰ç…§ç´¢å¼•å€¼å¤§å°å‡åºæ’åˆ—ï¼Œå­—ç¬¦ä¸²å±æ€§æ ¹æ®åˆ›å»ºæ—¶çš„é¡ºåºå‡åºæ’åˆ—ã€‚

åœ¨ V8 å†…éƒ¨ï¼Œä¸ºäº†æœ‰æ•ˆåœ°æå‡å­˜å‚¨å’Œè®¿é—®è¿™ä¸¤ç§å±æ€§çš„æ€§èƒ½ï¼Œåˆ†åˆ«ä½¿ç”¨äº†ä¸¤ä¸ª**çº¿æ€§æ•°æ®ç»“æ„**(æ•°ç»„å¯¹è±¡)æ¥åˆ†åˆ«ä¿å­˜æ’åºå±æ€§å’Œå¸¸è§„å±æ€§

å¦‚æœæ‰§è¡Œç´¢å¼•æ“ä½œï¼Œé‚£ä¹ˆ V8 ä¼šå…ˆä» elements å±æ€§ä¸­æŒ‰ç…§é¡ºåºè¯»å–æ‰€æœ‰çš„å…ƒç´ ï¼Œç„¶åå†åœ¨ properties å±æ€§ä¸­è¯»å–æ‰€æœ‰çš„å…ƒç´ ï¼Œè¿™æ ·å°±å®Œæˆä¸€æ¬¡ç´¢å¼•æ“ä½œã€‚

 -->

---

## å¯¹è±¡ä¸­çš„éšè—å±æ€§

- å¯¹è±¡å†…å±æ€§ (in-object properties)
- å¿«å±æ€§--çº¿æ€§ç»“æ„--æŸ¥æ‰¾å¿«
  - element
  - properties
- æ…¢å±æ€§--éçº¿æ€§ç»“æ„ (å­—å…¸)--ä¿®æ”¹å¿«
  - properties å¯¹è±¡å±æ€§å¢å¤šæ—¶é™çº§
- map--éšè—ç±»

<!-- ä¸è¿‡å¯¹è±¡å†…å±æ€§çš„æ•°é‡æ˜¯å›ºå®šçš„ï¼Œé»˜è®¤æ˜¯ 10 ä¸ªï¼Œå¦‚æœæ·»åŠ çš„å±æ€§è¶…å‡ºäº†å¯¹è±¡åˆ†é…çš„ç©ºé—´ï¼Œåˆ™å®ƒä»¬å°†è¢«ä¿å­˜åœ¨å¸¸è§„å±æ€§å­˜å‚¨ä¸­ã€‚è™½ç„¶å±æ€§å­˜å‚¨å¤šäº†ä¸€å±‚é—´æ¥å±‚ï¼Œä½†å¯ä»¥è‡ªç”±åœ°æ‰©å®¹ã€‚

é€šå¸¸ï¼Œæˆ‘ä»¬å°†ä¿å­˜åœ¨çº¿æ€§æ•°æ®ç»“æ„ä¸­çš„å±æ€§ç§°ä¹‹ä¸ºâ€œå¿«å±æ€§â€ï¼Œå› ä¸ºçº¿æ€§æ•°æ®ç»“æ„ä¸­åªéœ€è¦
é€šè¿‡ç´¢å¼•å³å¯ä»¥è®¿é—®åˆ°å±æ€§ï¼Œè™½ç„¶è®¿é—®çº¿æ€§ç»“æ„çš„é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å¦‚æœä»çº¿æ€§ç»“æ„ä¸­æ·»åŠ æˆ–è€…
åˆ é™¤å¤§é‡çš„å±æ€§æ—¶ï¼Œåˆ™æ‰§è¡Œæ•ˆç‡ä¼šéå¸¸ä½ï¼Œè¿™ä¸»è¦å› ä¸ºä¼šäº§ç”Ÿå¤§é‡æ—¶é—´å’Œå†…å­˜å¼€é”€ã€‚

-->

---

# V8 çš„å®¿ä¸»ç¯å¢ƒ

è¿è¡Œæ—¶ç¯å¢ƒ

- æ•°æ®å­˜å‚¨ç©ºé—´ï¼šå †ç©ºé—´å’Œæ ˆç©ºé—´
- å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡å’Œå…¨å±€ä½œç”¨åŸŸ
  - è¯æ³•ç¯å¢ƒ
  - å˜é‡ç¯å¢ƒ
  - this
- äº‹ä»¶å¾ªç¯ç³»ç»Ÿ

<!-- è¦æ‰§è¡Œ V8ï¼Œåˆ™éœ€è¦æœ‰ä¸€ä¸ªå®¿ä¸»ç¯å¢ƒï¼Œå®¿ä¸»ç¯å¢ƒå¯ä»¥æ˜¯æµè§ˆå™¨ä¸­çš„æ¸²æŸ“è¿›ç¨‹ï¼Œå¯ä»¥æ˜¯ Node.js è¿›ç¨‹, ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„å®šåˆ¶å¼€å‘çš„ç¯å¢ƒï¼Œè€Œè¿™äº›å®¿ä¸»åˆ™æä¾›äº†å¾ˆå¤šV8 æ‰§è¡Œ JavaScript æ—¶æ‰€éœ€çš„åŸºç¡€åŠŸèƒ½éƒ¨ä»¶


V8 å¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿï¼Œæ‰€ä»¥åœ¨æ‰§è¡Œæ—¶ï¼Œå®ƒçš„ä¸€éƒ¨åˆ†åŸºç¡€ç¯å¢ƒæ˜¯ç”±å®¿ä¸»æä¾›çš„ï¼Œè¿™åŒ…æ‹¬äº†å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ã€äº‹ä»¶å¾ªç¯ç³»ç»Ÿï¼Œå †ç©ºé—´å’Œæ ˆç©ºé—´ã€‚é™¤äº†éœ€è¦å®¿ä¸»æä¾›çš„ä¸€äº›åŸºç¡€ç¯å¢ƒä¹‹å¤–ï¼Œ

V8 è‡ªèº«ä¼šæä¾›JavaScript çš„æ ¸å¿ƒåŠŸèƒ½å’Œåƒåœ¾å›æ”¶ç³»ç»Ÿã€‚

CPU æ‰§è¡Œæœºå™¨ä»£ç çš„é€»è¾‘éå¸¸ç®€å•ï¼Œé¦–å…ˆç¼–è¯‘ä¹‹åçš„äºŒè¿›åˆ¶ä»£ç è¢«åŠ è½½è¿›å†…å­˜ï¼Œç„¶å CPUå°±æŒ‰ç…§æŒ‡ä»¤çš„é¡ºåºï¼Œä¸€è¡Œä¸€è¡Œåœ°æ‰§è¡Œã€‚


 -->

---

# æ ˆæº¢å‡º

æ˜¯å¦å­˜åœ¨å †æ ˆæº¢å‡ºé”™è¯¯?

<v-clicks>

```js
function foo() {
  foo();
}
foo();
```

```js
function foo() {
  setTimeout(foo, 0);
}
foo();
```

```js
function foo() {
  return Promise.resolve().then(foo);
}
foo();
```

</v-clicks>

---

## ä¸ºä»€ä¹ˆä½¿ç”¨æ ˆç®¡ç†å‡½æ•°è°ƒç”¨

<div class='mt-4'>

1. å¯ä»¥è¢«è°ƒç”¨
1. å…·æœ‰ä½œç”¨åŸŸæœºåˆ¶

</div>

<v-clicks>

è§‚å¯Ÿä¸‹é¢å‡½æ•°çš„æ‰§è¡Œæµç¨‹ ğŸ‘‡

```js {14|11|5|2|6|all}
function getZ() {
  return 4;
}
function add(x, y) {
  let z = getZ();
  return x + y + z;
}
function main() {
  let x = 5;
  let y = 6;
  let ret = add(x, y);
}

main();
```

å‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸå’Œèµ„æºåˆ†é…ç¬¦åˆ _LIFO_

</v-clicks>

<!-- ç¬¬ä¸€ä¸ªç‰¹ç‚¹æ˜¯å‡½æ•°å¯ä»¥è¢«è°ƒç”¨ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªå‡½æ•°ä¸­è°ƒç”¨å¦å¤–ä¸€ä¸ªå‡½æ•°ï¼Œå½“å‡½æ•°è°ƒç”¨å‘
ç”Ÿæ—¶ï¼Œæ‰§è¡Œä»£ç çš„æ§åˆ¶æƒå°†ä»çˆ¶å‡½æ•°è½¬ç§»åˆ°å­å‡½æ•°ï¼Œå­å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åï¼Œåˆä¼šå°†ä»£ç 
æ‰§è¡Œæ§åˆ¶æƒè¿”è¿˜ç»™çˆ¶å‡½æ•°ï¼›
1.
ç¬¬äºŒä¸ªç‰¹ç‚¹æ˜¯å‡½æ•°å…·æœ‰ä½œç”¨åŸŸæœºåˆ¶ï¼Œæ‰€è°“ä½œç”¨åŸŸæœºåˆ¶ï¼Œæ˜¯æŒ‡å‡½æ•°åœ¨æ‰§è¡Œçš„æ—¶å€™å¯ä»¥å°†å®š
ä¹‰åœ¨å‡½æ•°å†…éƒ¨çš„å˜é‡å’Œå¤–éƒ¨ç¯å¢ƒéš”ç¦»ï¼Œåœ¨å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡æˆ‘ä»¬ä¹Ÿç§°ä¸ºä¸´æ—¶å˜é‡ï¼Œä¸´
æ—¶å˜é‡åªèƒ½åœ¨è¯¥å‡½æ•°ä¸­è¢«è®¿é—®ï¼Œå¤–éƒ¨å‡½æ•°é€šå¸¸æ— æƒè®¿é—®ï¼Œå½“å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åï¼Œå­˜æ”¾åœ¨
å†…å­˜ä¸­çš„ä¸´æ—¶å˜é‡ä¹Ÿéšä¹‹è¢«é”€æ¯ã€‚ -->

---

## æ ˆå¦‚ä½•ç®¡ç†å‡½æ•°è°ƒç”¨

<div class='mt-4'>

1. `let`ï¼Œä¸´æ—¶å˜é‡å‹å…¥æ ˆ
1. `()`ï¼Œæ§åˆ¶æƒè½¬ç§»
1. `return`ï¼Œæ¢å¤ç°åœº

</div>

<v-clicks>

<div class="mt-4 text-2xl">å¦‚ä½•æ¢å¤</div>

<div class='mt-4'>

- esp å¯„å­˜å™¨ä¿å­˜æ ˆé¡¶æŒ‡é’ˆ
- ebp å¯„å­˜å™¨ä¿å­˜æ ˆå¸§æŒ‡é’ˆï¼ˆå½“å‰å‡½æ•°èµ·å§‹ä½ç½®ï¼‰

</div>
</v-clicks>

<!-- å°† esp çš„æŒ‡é’ˆå‘ä¸‹ç§»åŠ¨åˆ°ä¹‹å‰ main å‡½æ•°æ‰§è¡Œæ—¶çš„åœ°æ–¹å°±å¯ä»¥ï¼Œä¸è¿‡æ–°çš„é—®é¢˜åˆæ¥äº†ï¼ŒCPU æ˜¯æ€ä¹ˆçŸ¥é“è¦ç§»åŠ¨åˆ°è¿™ä¸ªåœ°å€å‘¢ï¼Ÿ -->

---

## æœ‰äº†æ ˆä¸ºä»€ä¹ˆè¿˜è¦å †

<v-clicks class='mt-10'>

- æ ˆç©ºé—´è¿ç»­
- æ“ä½œé€Ÿåº¦å¿«
- ç©ºé—´å¤§å°æœ‰é™

</v-clicks>

<!-- å› ä¸ºæ ˆç©ºé—´æ˜¯æœ‰é™çš„ï¼Œè¿™å°±å¯¼è‡´æˆ‘ä»¬åœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™ï¼Œç»å¸¸ä¸€ä¸å°å¿ƒå°±ä¼šå¯¼è‡´æ ˆæº¢å‡ºï¼Œæ¯”
å¦‚å‡½æ•°å¾ªç¯åµŒå¥—å±‚æ¬¡å¤ªå¤šï¼Œæˆ–è€…åœ¨æ ˆä¸Šåˆ†é…çš„æ•°æ®è¿‡å¤§ï¼Œéƒ½ä¼šå¯¼è‡´æ ˆæº¢å‡ºï¼ŒåŸºäºæ ˆä¸æ–¹ä¾¿å­˜
æ”¾å¤§çš„æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨äº†å¦å¤–ä¸€ç§æ•°æ®ç»“æ„ç”¨æ¥ä¿å­˜ä¸€äº›å¤§æ•°æ®ï¼Œè¿™å°±æ˜¯å †ã€‚ -->

---

# V8 å¦‚ä½•å®ç°é—­åŒ…

<v-clicks>

### æƒ°æ€§è§£æ

JavaScript ä¸‰ç‰¹æ€§

<div>
1. JavaScript è¯­è¨€å…è®¸åœ¨å‡½æ•°å†…éƒ¨å®šä¹‰æ–°çš„å‡½æ•°
</div>

<div class='mt-2'>
2. å¯ä»¥åœ¨å†…éƒ¨å‡½æ•°ä¸­è®¿é—®çˆ¶å‡½æ•°ä¸­å®šä¹‰çš„å˜é‡
</div>

<div class='mt-2'>
3. å› ä¸ºå‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘ï¼Œæ‰€ä»¥å‡½æ•°å¯ä»¥ä½œä¸ºè¿”å›å€¼
</div>

</v-clicks>

<!-- æ‰€è°“æƒ°æ€§è§£ææ˜¯æŒ‡è§£æå™¨åœ¨è§£æçš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°å‡½æ•°å£°æ˜ï¼Œé‚£ä¹ˆä¼šè·³è¿‡å‡½æ•°å†…éƒ¨çš„ä»£ç ï¼Œå¹¶ä¸ä¼šä¸ºå…¶ç”Ÿæˆ
AST å’Œå­—èŠ‚ç ï¼Œè€Œä»…ä»…ç”Ÿæˆé¡¶å±‚ä»£ç çš„ AST å’Œå­—èŠ‚ç ã€‚æƒ°æ€§è§£æå¯ä»¥åŠ é€Ÿ JavaScript ä»£ç çš„å¯åŠ¨é€Ÿåº¦ï¼Œå¦‚æœè¦å°†æ‰€æœ‰çš„ä»£ç ä¸€æ¬¡æ€§è§£æç¼–è¯‘å®Œæˆï¼Œé‚£ä¹ˆä¼šå¤§å¤§å¢åŠ ç”¨æˆ·çš„ç­‰å¾…æ—¶é—´ã€‚


é—­åŒ…å†…çš„å˜é‡ä¸èƒ½éšç€æ‰§è¡Œä¸Šä¸‹æ–‡è¢«é”€æ¯ï¼ŒV8 å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ
-->

---

## å¦‚ä½•è§£å†³é—­åŒ…å¸¦æ¥çš„é—®é¢˜

<v-clicks>

<div class='mt-4 text-2xl'>é¢„è§£æå™¨</div>

<div class='mt-4'>
1. åˆ¤æ–­å½“å‰å‡½æ•°æ˜¯ä¸æ˜¯å­˜åœ¨ä¸€äº›è¯­æ³•ä¸Šçš„é”™è¯¯
</div>
<div class='mt-4'>
2. æ˜¯æ£€æŸ¥å‡½æ•°å†…éƒ¨æ˜¯å¦å¼•ç”¨äº†å¤–éƒ¨å˜é‡
</div>

<div class='mt-8'>ä¸‹é¢ä»£ç çš„å˜é‡ a æ˜¯å­˜åœ¨æ ˆè¿˜æ˜¯å †å†…å­˜ä¸­ï¼Ÿ</div>

<div grid='~ cols-2 gap-4' class='mt-4'>

```js
function foo() {
  var a = 0;
}
```

```js
function foo() {
  var a = 0;
  return function inner() {
    return a++;
  };
}
```

</div>
</v-clicks>

<!--
å¦‚æœå¼•ç”¨äº†å¤–éƒ¨çš„å˜é‡ï¼Œé¢„è§£æå™¨ä¼šå°†æ ˆä¸­çš„å˜é‡å¤åˆ¶åˆ°å †ä¸­ï¼Œåœ¨ä¸‹æ¬¡æ‰§è¡Œåˆ°è¯¥å‡½æ•°çš„æ—¶å€™ï¼Œç›´æ¥ä½¿ç”¨å †ä¸­çš„å¼•ç”¨ï¼Œè¿™æ ·å°±è§£å†³äº†é—­åŒ…æ‰€å¸¦æ¥çš„é—®é¢˜ã€‚
-->

---

# V8 æ—©æœŸç¼–è¯‘æµç¨‹

<div grid='~ cols-2 gap-4'>

<v-clicks>

![v8 æ—©æœŸç¼–è¯‘æµç¨‹](/v8-compiled.png)

<div class='mt-12 ml-8'>

1. æ²¡æœ‰ä¸­é—´çš„å­—èŠ‚ç 
1. ä¸¤ä¸ªç¼–è¯‘å™¨

</div>
</v-clicks>

</div>

<style>
  img{
    height: 28vh;
  }
</style>

<!-- æ—©æœŸçš„ V8 ä¹‹æ‰€ä»¥æŠ›å¼ƒä¸­é—´å½¢å¼çš„ä»£ç ï¼Œç›´æ¥å°† JavaScript ä»£ç ç¼–è¯‘æˆæœºå™¨ä»£ç ï¼Œæ˜¯å› ä¸º
æœºå™¨ä»£ç çš„æ‰§è¡Œæ€§èƒ½éå¸¸é«˜æ•ˆï¼Œä½†æ˜¯æœ€æ–°ç‰ˆæœ¬å´æœç€æ‰§è¡Œæ€§èƒ½ç›¸åçš„æ–¹å‘è¿›åŒ–ï¼Œé‚£ä¹ˆè¿™æ˜¯å‡º
äºä»€ä¹ˆåŸå› å‘¢ï¼Ÿ -->

---

## ä¸ºä»€ä¹ˆåˆå¼•å…¥å­—èŠ‚ç 

<v-clicks>

<div grid='~ cols-2 gap-4'>

```mermaid { scale: 0.8}
graph LR
A[è¾“å…¥ä»£ç ] --> B{ç¼–è¯‘10s == æ‰§è¡Œ10s} --> C[è¾“å‡ºç»“æœ]
```

1. å°†ç¼–è¯‘åçš„äºŒè¿›åˆ¶ä»£ç ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼ˆin-memory cacheï¼‰
2. å½“æµè§ˆå™¨é€€å‡ºæ—¶ï¼Œç¼“å­˜ç¼–è¯‘åçš„äºŒè¿›åˆ¶ä»£ç åˆ°ç£ç›˜ä¸Š

</div>

<div class="mt-8 mb-4">
äºŒè¿›åˆ¶ä»£ç æ‰€å ç”¨çš„å†…å­˜ç©ºé—´æ˜¯ JavaScript ä»£ç çš„åå‡ å€ ğŸ¤¨
</div>

```mermaid {theme: 'neutral', scale: 0.8}
graph LR
A[function foo... = 5K] --> B[101010010001001001001011010010100101010100101010101011010... = 10M]
```

<div class="mt-8 mb-4">
å­—èŠ‚ç è™½ç„¶å ç”¨çš„ç©ºé—´æ¯”åŸå§‹çš„ JavaScript å¤šï¼Œä½†æ˜¯ç›¸è¾ƒäºæœºå™¨ä»£ç è¿˜æ˜¯å°äº†å¤ªå¤š âœ…
</div>

```mermaid { scale: 0.8}
graph LR
A[function foo... = 5K] --> B(Star r0 Add r0 Return... = 40K) --> C[101010010001001001001011010010100101010100101010101011010... = 10M]
```

ç”±æ­¤å¯è§ï¼Œä½¿ç”¨å­—èŠ‚ç èƒ½é™ä½å†…å­˜æ¶ˆè€—ï¼›æ­¤å¤–ä¹‹å¤–ï¼Œè¿˜æå‡å¯åŠ¨é€Ÿåº¦ã€é™ä½ä»£ç å¤æ‚åº¦

</v-clicks>

---

## å­—èŠ‚ç è§£å†³äº†å“ªäº›é—®é¢˜

<v-clicks>

- è§£é‡Šå™¨å¯ä»¥å¿«é€Ÿç”Ÿæˆå­—èŠ‚ç ï¼Œä½†è§£é‡Šå™¨æ‰§è¡Œå­—èŠ‚ç éœ€è¦æ›´é•¿çš„æ—¶é—´ã€‚
- å¼•å…¥äº†å­—èŠ‚ç ï¼Œå°±å¯ä»¥ç»Ÿä¸€å°†å­—èŠ‚ç è½¬æ¢ä¸ºä¸åŒå¹³å°çš„äºŒè¿›åˆ¶ä»£ç ã€‚
- è§£å†³å¯åŠ¨é—®é¢˜ï¼šç”Ÿæˆå­—èŠ‚ç çš„æ—¶é—´å¾ˆçŸ­ï¼›
- è§£å†³ç©ºé—´é—®é¢˜ï¼šå­—èŠ‚ç å ç”¨å†…å­˜ä¸å¤šï¼Œç¼“å­˜å­—èŠ‚ç ä¼šå¤§å¤§é™ä½å†…å­˜çš„ä½¿ç”¨ï¼›
- ä»£ç æ¶æ„æ¸…æ™°ï¼šé‡‡ç”¨å­—èŠ‚ç ï¼Œå¯ä»¥ç®€åŒ–ç¨‹åºçš„å¤æ‚åº¦ï¼Œä½¿å¾— V8 ç§»æ¤åˆ°ä¸åŒçš„ CPU æ¶æ„
  å¹³å°æ›´åŠ å®¹æ˜“ã€‚

</v-clicks>

<!-- 1. è§£é‡Šå™¨å¯ä»¥ç›´æ¥è§£é‡Šæ‰§è¡Œå­—èŠ‚ç 
1. ä¼˜åŒ–ç¼–è¯‘å™¨å¯ä»¥å°†å­—èŠ‚ç ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶ä»£ç ï¼Œç„¶åå†æ‰§è¡ŒäºŒè¿›åˆ¶æœºå™¨ä»£ç  -->

---

# å¦‚ä½•åœ¨å†…å­˜ä¸­å¿«é€ŸæŸ¥æ‰¾å¯¹è±¡å±æ€§

é™æ€è¯­è¨€æ•ˆç‡æ›´é«˜

<div grid='~ cols-2 gap-4'>

```js
let point = {
  x: 100,
  y: 100,
};
```

```c
struct Point{
  int x;
  int y;
}
Point start;
start.x = 100;
start.y = 100;
```

</div>

<v-click>

å‡è®¾

- å¯¹è±¡åˆ›å»ºå¥½äº†ä¹‹åå°±ä¸ä¼šæ·»åŠ æ–°çš„å±æ€§ï¼›
- å¯¹è±¡åˆ›å»ºå¥½äº†ä¹‹åä¹Ÿä¸ä¼šåˆ é™¤å±æ€§ã€‚

</v-click>

<!-- é™æ€è¯­è¨€ä¸­ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡åç§»é‡æŸ¥è¯¢æ¥æŸ¥è¯¢å¯¹è±¡çš„å±æ€§å€¼ï¼Œè¿™ä¹Ÿå°±æ˜¯é™æ€è¯­è¨€çš„æ‰§è¡Œæ•ˆç‡é«˜çš„ä¸€ä¸ªåŸå› ã€‚ -->

---

## éšè—ç±»ï¼ˆHiden Classï¼‰

<v-clicks>

1. å¯¹è±¡ä¸­æ‰€åŒ…å«çš„æ‰€æœ‰çš„å±æ€§ï¼›
1. æ¯ç§ç±»å‹ç›¸å¯¹äºå¯¹è±¡çš„åç§»é‡ã€‚

```js
let point = {
  x: 100,
  y: 100,
};
```

![éšè—ç±»](/map.png)

</v-clicks>

<style>
  img{
    height: 28vh;
  }
</style>

<!-- V8 ä¼šä¸ºæ¯ä¸ªå¯¹è±¡åˆ›å»ºä¸€ä¸ªéšè—ç±»ï¼Œå¯¹è±¡çš„éšè—ç±»ä¸­è®°å½•äº†è¯¥å¯¹è±¡ä¸€äº›åŸºç¡€çš„å¸ƒå±€ä¿¡æ¯

å°†åŠ¨æ€è¯­è¨€é™æ€åŒ–çš„ä¸€ä¸ªæ“ä½œï¼ŒV8 é€šè¿‡å¼•å…¥éšè—ç±»ï¼Œæ¨¡æ‹Ÿ C++ è¿™ç§é™æ€è¯­è¨€çš„æœº
åˆ¶ï¼Œä»è€Œè¾¾åˆ°é™æ€è¯­è¨€çš„æ‰§è¡Œæ•ˆç‡ã€‚

-->

---

## éšè—ç±»å¤ç”¨

<v-clicks>

å½¢çŠ¶ç›¸åŒçš„å¯¹è±¡ ğŸ•µï¸â€â™‚ï¸

1. ç›¸åŒçš„å±æ€§åç§°ï¼›
1. ç›¸ç­‰çš„å±æ€§ä¸ªæ•°ã€‚

```js
let point = { x: 100, y: 200 };
let point2 = { x: 3, y: 4 };
```

<div grid='~ cols-2 gap-4'>

![reuse](/map-reuse.png)

<div>

æœ€ä½³å®è·µ

1. ä½¿ç”¨å­—é¢é‡åˆå§‹åŒ–å¯¹è±¡æ—¶ï¼Œè¦ä¿è¯å±æ€§çš„é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚
1. å°½é‡ä½¿ç”¨å­—é¢é‡ä¸€æ¬¡æ€§åˆå§‹åŒ–å®Œæ•´å¯¹è±¡å±æ€§ã€‚
1. å°½é‡é¿å…ä½¿ç”¨ delete æ–¹æ³•ã€‚

</div>

</div>

</v-clicks>

<style>
  img{
    height: 28vh;
  }
</style>

<!--
V8 ä¼šä¸ºæ¯ä¸ªå¯¹è±¡åˆ†é…ä¸€ä¸ªéšè—ç±»ï¼Œ
æœ‰äº†éšè—ç±»ï¼ŒV8 å°±å¯ä»¥æ ¹æ®éšè—ç±»ä¸­æè¿°çš„åç§»åœ°å€è·å–å¯¹åº”çš„å±æ€§
å€¼ï¼Œè¿™æ ·å°±çœå»äº†å¤æ‚çš„æŸ¥æ‰¾æµç¨‹ã€‚


åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼šå¦‚æœå¯¹è±¡çš„å½¢çŠ¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±ä¼šä¸€ç›´ä½¿ç”¨è¯¥éšè—ç±»ï¼›
å¦‚æœå¯¹è±¡çš„å½¢çŠ¶å‘ç”Ÿäº†æ”¹å˜ï¼Œé‚£ä¹ˆ V8 ä¼šé‡å»ºä¸€ä¸ªæ–°çš„éšè—ç±»ç»™è¯¥å¯¹è±¡ã€‚ -->

---

## å†…è”ç¼“å­˜ï¼ˆInline Cacheï¼‰

<v-clicks>

```js
function loadX(o) {
  return o.x;
}
var o = { x: 1, y: 3 };
var o1 = { x: 3, y: 6 };
for (var i = 0; i < 90000; i++) {
  loadX(o);
  loadX(o1);
}
```

1. æŸ¥æ‰¾å¯¹è±¡ o çš„éšè—ç±»ï¼Œ
1. å†é€šè¿‡éšè—ç±»æŸ¥æ‰¾ x å±æ€§åç§»é‡ï¼Œ
1. ç„¶åæ ¹æ®åç§»é‡è·å–å±æ€§å€¼

1ã€ç¼“å­˜ä»€ä¹ˆï¼Ÿ

**è°ƒç”¨ç‚¹ (CallSite)** ä¸Šçš„å…³é”®çš„ä¸­é—´æ•°æ®

2ã€ç¼“å­˜åœ¨å“ªï¼Ÿ

**åé¦ˆå‘é‡ (FeedBack Vector)**ï¼Œè¡¨ç»“æ„ï¼Œå…¶ä¸­æ¯ä¸€é¡¹ç§°ä¸ºä¸€ä¸ª**æ’æ§½ï¼ˆSlotï¼‰**

</v-clicks>

---

## åé¦ˆå‘é‡ï¼ˆFeedBack Vectorï¼‰

![FeedBack Vector](/fb-vector.png)

<v-click>

type

- å­˜å‚¨ (STORE) ç±»å‹çš„æ“ä½œ `o.y=13`
- è°ƒç”¨ (CALL) ç±»å‹çš„æ“ä½œ `foo()`
- åŠ è½½ (LOAD) ç±»å‹çš„æ“ä½œ `o.x`

</v-click>

---

### å¤šæ€å’Œè¶…æ€

<v-clicks>

åé¦ˆå‘é‡è¿˜å­˜å‚¨äº†æ¯ä¸ªæ’æ§½çš„çŠ¶æ€ï¼ˆstateï¼‰ä¿¡æ¯

- å•æ€ï¼ˆmonomorphicï¼‰ï¼šä¸€ä¸ªæ’æ§½ä¸­åªåŒ…å« 1 ä¸ªéšè—ç±»
- å¤šæ€ï¼ˆpolymorphicï¼‰ï¼šä¸€ä¸ªæ’æ§½ä¸­åŒ…å«äº† 2 ï½ 4 ä¸ªéšè—ç±»
- è¶…æ€ï¼ˆmagamorphicï¼‰ï¼šä¸€ä¸ªæ’æ§½ä¸­è¶…è¿‡ 4 ä¸ªéšè—ç±»

```js
function loadX(o) {
  return o.x;
}
var o = { x: 1, y: 3 };
var o1 = { x: 3, y: 6, z: 4 };
for (var i = 0; i < 90000; i++) {
  loadX(o);
  loadX(o1);
}
```

å¯¹è±¡ o å’Œ o1 çš„å½¢çŠ¶æ˜¯ä¸åŒçš„ï¼Œè¿™æ„å‘³ç€ V8 ä¸ºå®ƒä»¬åˆ›å»ºçš„éšè—ç±»ï¼ˆmapï¼‰ä¹Ÿæ˜¯ä¸åŒçš„ã€‚è¿™å°±å½¢æˆäº†å¤šæ€ã€‚

_å•æ€çš„æ€§èƒ½ä¼˜äºå¤šæ€å’Œè¶…æ€_

</v-clicks>

<!-- è™½ç„¶æˆ‘ä»¬åˆ†æçš„éšè—ç±»å’Œ IC èƒ½æå‡ä»£ç çš„æ‰§è¡Œé€Ÿåº¦ï¼Œä½†æ˜¯åœ¨å®é™…çš„
é¡¹ç›®ä¸­ï¼Œå½±å“æ‰§è¡Œæ€§èƒ½çš„å› ç´ éå¸¸å¤šï¼Œæ‰¾å‡ºé‚£äº›å½±å“æ€§èƒ½ç“¶é¢ˆæ‰æ˜¯è‡³å…³é‡è¦çš„ï¼Œä½ ä¸éœ€è¦è¿‡
åº¦å…³æ³¨å¾®ä¼˜åŒ–ï¼Œä½ ä¹Ÿä¸éœ€è¦è¿‡åº¦æ‹…å¿§ä½ çš„ä»£ç æ˜¯å¦ç ´åäº†éšè—ç±»æˆ–è€… IC çš„æœºåˆ¶ï¼Œå› ä¸ºç›¸å¯¹
äºå…¶ä»–çš„æ€§èƒ½ç“¶é¢ˆï¼Œå®ƒä»¬å¯¹æ•ˆç‡çš„å½±å“å¯èƒ½æ˜¯å¾®ä¸è¶³é“çš„ã€‚ -->

---

# äº‹ä»¶å¾ªç¯

<v-clicks>

### V8 å¦‚ä½•å®ç°å›è°ƒå‡½æ•°

åŒæ­¥å›è°ƒå’Œå¼‚æ­¥å›è°ƒ

<div grid='~ cols-2 gap-4'>

```js
var myArray = ["water", "goods", "123", "like"];
function handlerArray(indexName, index) {
  console.log(index + ". " + indexName);
}
myArray.forEach(handlerArray);
```

```js
function foo() {
  alert("Hello");
}
setTimeout(foo, 3000);
```

</div>

å¼‚æ­¥å›è°ƒä»€ä¹ˆæ—¶æœºã€åœ¨ä»€ä¹ˆä½ç½®è¢«è°ƒç”¨ï¼Ÿ

</v-clicks>

<!-- åŒæ­¥å›è°ƒå‡½æ•°æ˜¯åœ¨æ‰§è¡Œå‡½æ•°å†…éƒ¨è¢«æ‰§è¡Œçš„ï¼Œè€Œå¼‚æ­¥å›è°ƒå‡½æ•°æ˜¯åœ¨æ‰§è¡Œå‡½æ•°å¤–éƒ¨è¢«æ‰§è¡Œçš„ã€‚

-->

---

## UI ä¸»çº¿ç¨‹

<v-clicks>

![UIçº¿ç¨‹æ¶æ„](/ui-thread.png)

```js
function UIMainThread() {
  while (queue.waitForMessage()) {
    const task = queue.getNext();
    processNextMessage(task);
  }
}
```

</v-clicks>

<style>
  img{
    height: 30vh;
  }
</style>

<!-- æˆ‘ä»¬æŠŠ UI çº¿ç¨‹æ¯æ¬¡ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºäº‹ä»¶ï¼Œæ‰§è¡Œäº‹ä»¶çš„è¿‡ç¨‹ç§°ä¸ºä¸€ä¸ªä»»åŠ¡

è¿™å°±æ˜¯é€šç”¨çš„ UI çº¿ç¨‹çš„ç»“æ„ï¼Œæœ‰æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé€šè¿‡é¼ æ ‡ã€é”®ç›˜ã€è§¦æ§æ¿ç­‰äº§ç”Ÿçš„æ¶ˆæ¯éƒ½ä¼šè¢«
æ·»åŠ è¿›æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸»çº¿ç¨‹ä¼šå¾ªç¯åœ°ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯å¹¶æ‰§è¡Œã€‚

å…³äºå¼‚æ­¥å›è°ƒï¼Œä¹Ÿæœ‰ä¸¤ç§ä¸åŒçš„ç±»å‹ï¼Œå…¶å…¸å‹ä»£è¡¨æ˜¯ setTimeout å’Œ
XMLHttpRequestã€‚

setTimeout çš„æ‰§è¡Œæµç¨‹å…¶å®æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œåœ¨
setTimeout å‡½æ•°å†…éƒ¨å°è£…å›è°ƒæ¶ˆæ¯ï¼Œå¹¶å°†å›è°ƒæ¶ˆæ¯æ·»åŠ è¿›æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åä¸»çº¿ç¨‹ä»æ¶ˆæ¯é˜Ÿ
åˆ—ä¸­å–å‡ºå›è°ƒäº‹ä»¶ï¼Œå¹¶æ‰§è¡Œ

XMLHttpRequest ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå› ä¸ºä¸‹è½½è¿‡ç¨‹éœ€è¦æ”¾åˆ°å•ç‹¬çš„ä¸€ä¸ªçº¿ç¨‹ä¸­å»æ‰§è¡Œï¼Œæ‰€ä»¥
æ‰§è¡Œ XMLHttpRequest.send çš„æ—¶å€™ï¼Œå®¿ä¸»ä¼šå°†å®é™…è¯·æ±‚è½¬å‘ç»™ç½‘ç»œçº¿ç¨‹ï¼Œç„¶å send å‡½
æ•°é€€å‡ºï¼Œä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œä¸‹é¢çš„ä»»åŠ¡ã€‚ç½‘ç»œçº¿ç¨‹åœ¨æ‰§è¡Œä¸‹è½½çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå°†ä¸€äº›ä¸­é—´ä¿¡æ¯å’Œ
å›è°ƒå‡½æ•°å°è£…æˆæ–°çš„æ¶ˆæ¯ï¼Œå¹¶å°†å…¶æ·»åŠ è¿›æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç„¶åä¸»çº¿ç¨‹ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºå›è°ƒäº‹
ä»¶ï¼Œå¹¶æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚


-->

---

# V8 å¦‚ä½•å®ç°å¾®ä»»åŠ¡

- å®ä»»åŠ¡ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ç­‰å¾…è¢«ä¸»çº¿ç¨‹æ‰§è¡Œçš„äº‹ä»¶
- å¾®ä»»åŠ¡ï¼šä¸€ä¸ªéœ€è¦å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°

<v-click>

![å¾®ä»»åŠ¡](/micro-task.png)

</v-click>

<!-- å¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶æœºæ˜¯åœ¨ä¸»å‡½æ•°æ‰§è¡Œç»“æŸä¹‹åã€å½“å‰å®ä»»åŠ¡ç»“æŸä¹‹å‰ã€‚ -->

---

## è°ƒç”¨æ ˆ|ä¸»çº¿ç¨‹|æ¶ˆæ¯é˜Ÿåˆ—

<v-clicks>

- è°ƒç”¨æ ˆç®¡ç†ä¸»çº¿ç¨‹ä¸Šçš„å‡½æ•°è°ƒç”¨
- å¾®ä»»åŠ¡åœ¨å½“å‰å®ä»»åŠ¡è°ƒç”¨æ ˆçš„å…¨å±€æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­

Let's see it one more time!

<div grid='~ cols-3 gap-4'>

```js
function foo() {
  foo();
}
foo();
```

```js
function foo() {
  setTimeout(foo, 0);
}
foo();
```

```bash
function foo() {
  return Promise.resolve()
  .then(foo);
}
foo();
```

</div>

æ€è€ƒï¼šæµè§ˆå™¨ä¸­çš„ MutationObserver æ¥å£ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¾®ä»»åŠ¡ï¼Ÿ

</v-clicks>

<!-- è°ƒç”¨æ ˆæ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨æ¥ç®¡ç†åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œçš„å‡½æ•°çš„è°ƒç”¨å…³ç³»

å¾®ä»»åŠ¡å¯ä»¥åœ¨å®æ—¶æ€§å’Œæ•ˆç‡ä¹‹é—´åšæœ‰æ•ˆçš„æƒè¡¡

V8 ä¼šä¸ºæ¯ä¸ªå®ä»»åŠ¡ç»´æŠ¤ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚å½“ V8 æ‰§è¡Œä¸€æ®µ JavaScript æ—¶ï¼Œä¼š
ä¸ºè¿™æ®µä»£ç åˆ›å»ºä¸€ä¸ªç¯å¢ƒå¯¹è±¡ï¼Œå¾®ä»»åŠ¡é˜Ÿåˆ—å°±æ˜¯å­˜æ”¾åœ¨è¯¥ç¯å¢ƒå¯¹è±¡ä¸­çš„ã€‚å½“ä½ é€šè¿‡
Promise.resolve ç”Ÿæˆä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œè¯¥å¾®ä»»åŠ¡ä¼šè¢« V8 è‡ªåŠ¨æ·»åŠ è¿›å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰æ•´æ®µä»£ç 
å¿«è¦æ‰§è¡Œç»“æŸæ—¶ï¼Œè¯¥ç¯å¢ƒå¯¹è±¡ä¹Ÿéšä¹‹è¢«é”€æ¯ï¼Œä½†æ˜¯åœ¨é”€æ¯ä¹‹å‰ï¼ŒV8 ä¼šå…ˆå¤„ç†å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­
çš„å¾®ä»»åŠ¡ã€‚

-->

---

# V8 æ˜¯å¦‚ä½•å®ç° async/await çš„ï¼Ÿ

<v-clicks>

å›è°ƒæ—¢åœ°ç‹±

Promise

Generatorï¼ˆåç¨‹ï¼‰+ æ‰§è¡Œå™¨ï¼ˆcoï¼‰

async/await

async æ˜¯ä¸€ä¸ªé€šè¿‡**å¼‚æ­¥æ‰§è¡Œå¹¶éšå¼è¿”å› Promise** ä½œä¸ºç»“æœçš„å‡½æ•°

await ç­‰å¾…çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡

æé—®ï¼šco çš„è¿è¡ŒåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

</v-clicks>

<!-- å›è°ƒé€ æˆä»£ç é€»è¾‘éçº¿æ€§ï¼Œä¸æ˜“ç†è§£

ä½¿ç”¨ Promise å¯ä»¥è§£å†³å›è°ƒåœ°ç‹±ä¸­ç¼–ç ä¸çº¿æ€§çš„é—®é¢˜

æ›´åŠ çº¿æ€§çš„ç¼–ç æ–¹å¼ï¼šæ‰§è¡Œåˆ°å¼‚æ­¥è¯·æ±‚çš„æ—¶å€™ï¼Œæš‚åœå½“å‰å‡½æ•°ï¼Œç­‰å¼‚æ­¥è¯·æ±‚è¿”å›äº†ç»“æœï¼Œå†æ¢å¤è¯¥å‡½æ•°ã€‚


åœ¨ç”Ÿæˆå™¨å†…éƒ¨ï¼Œå¦‚æœé‡åˆ° yield å…³é”®å­—ï¼Œé‚£ä¹ˆ V8 å°†è¿”å›å…³
é”®å­—åé¢çš„å†…å®¹ç»™å¤–éƒ¨ï¼Œå¹¶æš‚åœè¯¥ç”Ÿæˆå™¨å‡½æ•°çš„æ‰§è¡Œã€‚ç”Ÿæˆå™¨æš‚åœæ‰§è¡Œåï¼Œå¤–éƒ¨çš„ä»£ç ä¾¿å¼€
å§‹æ‰§è¡Œï¼Œå¤–éƒ¨ä»£ç å¦‚æœæƒ³è¦æ¢å¤ç”Ÿæˆå™¨çš„æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨ result.next æ–¹æ³•ã€‚

ç”Ÿæˆå™¨ä¾ç„¶éœ€è¦ä½¿ç”¨é¢å¤–çš„ co å‡½æ•°æ¥é©±åŠ¨ç”Ÿæˆå™¨å‡½æ•°çš„æ‰§è¡Œï¼Œè¿™ä¸€ç‚¹éå¸¸ä¸å‹å¥½ã€‚
async/awaitæ”¹è¿›äº†ç”Ÿæˆå™¨çš„ç¼ºç‚¹ï¼Œæä¾›äº†åœ¨ä¸é˜»å¡ä¸»çº¿ç¨‹çš„æƒ…å†µä¸‹ä½¿ç”¨åŒæ­¥ä»£ç å®ç°å¼‚æ­¥è®¿é—®èµ„æºçš„èƒ½åŠ›

await ç­‰å¾…çš„æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå®ƒå°±ä¼šæš‚åœæ‰§è¡Œç”Ÿæˆå™¨å‡½æ•°ï¼Œç›´åˆ° Promise å¯¹
è±¡çš„çŠ¶æ€å˜æˆ resolve/rejectï¼Œæ‰ä¼šæ¢å¤æ‰§è¡Œï¼Œç„¶åå¾—åˆ°çš„å€¼ä½œä¸º await è¡¨è¾¾å¼çš„è¿ç®—ç»“æœã€‚

-->

---

# V8 çš„åƒåœ¾å›æ”¶æœºåˆ¶

GC æµç¨‹

<v-click>

GC Root + reachability

</v-click>

<v-click>

1. GC Root æ ‡è®°

- å…¨å±€çš„ window å¯¹è±¡ï¼ˆä½äºæ¯ä¸ª iframe ä¸­ï¼‰ï¼›
- æ–‡æ¡£ DOM æ ‘ï¼Œç”±å¯ä»¥é€šè¿‡éå†æ–‡æ¡£åˆ°è¾¾çš„æ‰€æœ‰åŸç”Ÿ DOM èŠ‚ç‚¹ç»„æˆï¼›
- å­˜æ”¾æ ˆä¸Šå˜é‡ã€‚

</v-click>

<v-click>

2. æ¸…ç† unreachable

</v-click>

<v-click>

3. æ•´ç†**å†…å­˜ç¢ç‰‡**

</v-click>

<!--
GC Root å¯¹è±¡ï¼šåˆå§‹å­˜æ´»çš„å¯¹è±¡çš„é›†åˆ

å¯è®¿é—®æ€§ï¼ˆreachabilityï¼‰ç®—æ³•ï¼šåˆ¤æ–­æ´»åŠ¨å¯¹è±¡å’Œéæ´»åŠ¨å¯¹è±¡
 -->

---

## ä»£é™…å‡è¯´ï¼ˆThe Generational Hypothesisï¼‰

<v-clicks>

- å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯â€œæœç”Ÿå¤•æ­»â€çš„
- ä¸æ­»çš„å¯¹è±¡ï¼Œä¼šæ´»å¾—æ›´ä¹…

<!-- ä¸»åƒåœ¾å›æ”¶å™¨ **Major GC**ï¼Œä¸»è¦è´Ÿè´£è€ç”Ÿä»£çš„åƒåœ¾å›æ”¶ã€‚ -->

å‰¯åƒåœ¾å›æ”¶å™¨ **Minor GC (Scavenger)**ï¼Œä¸»è¦è´Ÿè´£æ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶ã€‚

![æ–°ç”Ÿä»£åƒåœ¾å›æ”¶](/scavenge.png)

ä¸ºäº†æ‰§è¡Œæ•ˆç‡ï¼Œä¸€èˆ¬æ–°ç”ŸåŒºçš„ç©ºé—´ä¼šè¢«è®¾ç½®å¾—æ¯”è¾ƒ**å°**

å‰¯åƒåœ¾å›æ”¶å™¨è¿˜ä¼šé‡‡ç”¨**å¯¹è±¡æ™‹å‡**ç­–ç•¥

</v-clicks>

<style>
  img{
    height: 29vh;
  }
</style>

<!-- ä»£é™…å‡è¯´æ˜¯åƒåœ¾å›æ”¶é¢†åŸŸä¸­ä¸€ä¸ªé‡è¦çš„æœ¯è¯­ï¼ŒåŒæ ·é€‚åˆJavaã€Python

å¦‚æœæˆ‘ä»¬åªä½¿ç”¨ä¸€ä¸ªåƒåœ¾å›æ”¶å™¨ï¼Œåœ¨ä¼˜åŒ–å¤§å¤šæ•°æ–°å¯¹è±¡çš„åŒæ—¶ï¼Œå°±å¾ˆéš¾ä¼˜åŒ–åˆ°é‚£äº›è€å¯¹è±¡ï¼Œ
å› æ­¤ä½ éœ€è¦æƒè¡¡å„ç§åœºæ™¯ï¼Œæ ¹æ®å¯¹è±¡ç”Ÿå­˜å‘¨æœŸçš„ä¸åŒï¼Œè€Œä½¿ç”¨ä¸åŒçš„ç®—æ³•ï¼Œä»¥ä¾¿è¾¾åˆ°æœ€å¥½çš„
æ•ˆæœã€‚

æ–°ç”Ÿä»£é€šå¸¸åªæ”¯æŒ 1ï½8M çš„å®¹é‡ï¼Œè€Œè€ç”Ÿä»£æ”¯æŒçš„å®¹é‡å°±å¤§å¾ˆå¤šäº†ã€‚æ–°ç”Ÿä»£ä¸­å­˜æ”¾çš„æ˜¯ç”Ÿå­˜æ—¶é—´çŸ­çš„å¯¹è±¡ï¼Œè€ç”Ÿä»£ä¸­å­˜æ”¾ç”Ÿå­˜æ—¶é—´ä¹…çš„å¯¹è±¡ã€‚

Scavenger-Compactï¼šé¦–å…ˆå¯¹å¯¹è±¡åŒºåŸŸä¸­çš„åƒåœ¾åšæ ‡è®°ï¼›æ ‡è®°å®Œæˆä¹‹åï¼Œå°±è¿›å…¥åƒåœ¾æ¸…ç†é˜¶æ®µã€‚å‰¯åƒåœ¾å›æ”¶å™¨ä¼šæŠŠè¿™äº›å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°ç©ºé—²åŒºåŸŸä¸­ï¼ŒåŒæ—¶å®ƒè¿˜ä¼šæŠŠè¿™äº›å¯¹è±¡æœ‰åºåœ°æ’åˆ—èµ·æ¥ï¼Œæ‰€ä»¥è¿™ä¸ª**å¤åˆ¶**è¿‡ç¨‹ï¼Œä¹Ÿå°±ç›¸å½“äºå®Œæˆäº†å†…å­˜**æ•´ç†**æ“ä½œï¼Œå¤åˆ¶åç©ºé—²åŒºåŸŸå°±æ²¡æœ‰å†…å­˜ç¢ç‰‡äº†ã€‚

å®Œæˆå¤åˆ¶åï¼Œå¯¹è±¡åŒºåŸŸä¸ç©ºé—²åŒºåŸŸè¿›è¡Œè§’è‰²**ç¿»è½¬**ï¼Œä¹Ÿå°±æ˜¯åŸæ¥çš„å¯¹è±¡åŒºåŸŸå˜æˆç©ºé—²åŒºåŸŸï¼ŒåŸæ¥çš„ç©ºé—²åŒºåŸŸå˜æˆäº†å¯¹è±¡åŒºåŸŸã€‚è¿™æ ·å°±å®Œæˆäº†åƒåœ¾å¯¹è±¡çš„å›æ”¶æ“ä½œï¼ŒåŒæ—¶ï¼Œè¿™ç§**è§’è‰²ç¿»è½¬çš„æ“ä½œè¿˜èƒ½è®©æ–°ç”Ÿä»£ä¸­çš„è¿™ä¸¤å—åŒºåŸŸæ— é™é‡å¤ä½¿ç”¨ä¸‹å»**ã€‚

å¯¹è±¡æ™‹å‡ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ç§»åŠ¨é‚£äº›ç»è¿‡ä¸¤æ¬¡åƒåœ¾å›æ”¶ä¾ç„¶è¿˜å­˜æ´»çš„å¯¹è±¡åˆ°è€ç”Ÿä»£ä¸­
 -->

---

## ä¸»åƒåœ¾å›æ”¶å™¨

<v-clicks>

æ ‡è®° - æ¸…é™¤ï¼ˆMark-Sweepï¼‰

1. æ ‡è®°
1. ç›´æ¥æ¸…é™¤

æ ‡è®° - æ•´ç†ï¼ˆMark-Compactï¼‰

```js
function strToArray(str) {
  let i = 0;
  const len = str.length;
  let arr = new Uint16Array(str.length);
  for (; i < len; ++i) {
    arr[i] = str.charCodeAt(i);
  }
  return arr;
}
function foo() {
  let i = 0;
  let str = "test V8 GC";
  while (i++ < 1e5) strToArray(str);
}
// V8 æ‰§è¡Œè¿™æ®µä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œäº§ç”Ÿäº†å“ªäº›åƒåœ¾æ•°æ®ã€‚ç«™åœ¨å†…å­˜ç©ºé—´å’Œä¸»çº¿ç¨‹èµ„æºçš„è§’åº¦æ¥åˆ†æï¼Œå¦‚ä½•ä¼˜åŒ–è¿™æ®µä»£ç ;
foo();
```

</v-clicks>

<!--
å¯¹ä¸€å—å†…å­˜å¤šæ¬¡æ‰§è¡Œæ ‡è®° -æ¸…é™¤ç®—æ³•åï¼Œä¼šäº§ç”Ÿå¤§é‡ä¸è¿ç»­çš„å†…å­˜ç¢ç‰‡ã€‚

Mark-Compact åç»­æ­¥éª¤ä¸æ˜¯ç›´æ¥å¯¹å¯å›æ”¶å¯¹è±¡è¿›è¡Œæ¸…ç†ï¼Œè€Œæ˜¯è®©æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åç›´æ¥æ¸…ç†æ‰è¿™ä¸€ç«¯ä¹‹å¤–çš„å†…å­˜ã€‚ -->

---

## GC ä¼˜åŒ–

<v-clicks>

å…¨åœé¡¿ï¼ˆStop-The-Worldï¼‰

æ–¹æ³•è®º âœï¸

1. å°†ä¸€ä¸ªå®Œæ•´çš„åƒåœ¾å›æ”¶çš„ä»»åŠ¡æ‹†åˆ†æˆå¤šä¸ªå°çš„ä»»åŠ¡
1. å°†æ ‡è®°å¯¹è±¡ã€ç§»åŠ¨å¯¹è±¡ç­‰ä»»åŠ¡è½¬ç§»åˆ°åå°çº¿ç¨‹è¿›è¡Œ

å®è·µè®º ğŸ“Œ

- å¹¶è¡Œ(Parallel)å›æ”¶
- å¢é‡å›æ”¶
- å¹¶å‘(concurrent)å›æ”¶

</v-clicks>

<!-- å‘ç°æœ‰çš„åƒåœ¾å›æ”¶å™¨æ·»åŠ å¹¶è¡Œã€å¹¶å‘å’Œå¢é‡ç­‰åƒåœ¾å›æ”¶æŠ€æœ¯ -->

---

## å¹¶è¡Œï¼ˆParallelï¼‰å›æ”¶

<v-clicks>

å¼€å¯å¤šä¸ªååŠ©çº¿ç¨‹ï¼ŒåŒæ—¶æ‰§è¡ŒåŒæ ·çš„å›æ”¶å·¥ä½œ

![å¹¶è¡Œå›æ”¶](/parallel.awebp)

ä»ç„¶å±äºå…¨åœé¡¿ GC

</v-clicks>

<!-- V8 çš„å‰¯åƒåœ¾å›æ”¶å™¨æ‰€é‡‡ç”¨çš„å°±æ˜¯å¹¶è¡Œç­–ç•¥ï¼Œå®ƒåœ¨æ‰§è¡Œåƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œå¯åŠ¨äº†å¤šä¸ªçº¿ç¨‹æ¥è´Ÿè´£æ–°ç”Ÿä»£ä¸­çš„åƒåœ¾æ¸…ç†æ“ä½œï¼Œè¿™äº›çº¿ç¨‹åŒæ—¶å°†å¯¹è±¡ç©ºé—´ä¸­çš„æ•°æ®ç§»åŠ¨åˆ°ç©ºé—²åŒºåŸŸã€‚ç”±äºæ•°æ®çš„åœ°å€å‘ç”Ÿäº†æ”¹å˜ï¼Œæ‰€ä»¥è¿˜éœ€è¦åŒæ­¥æ›´æ–°å¼•ç”¨è¿™äº›å¯¹è±¡çš„æŒ‡é’ˆã€‚ -->

---

## å¢é‡å›æ”¶

<v-clicks>

![å¢é‡æ ‡è®°](/more-tag.awebp)

å¢é‡å›æ”¶æ˜¯å¹¶å‘çš„ï¼ˆconcurrentï¼‰

1. ä¸‰è‰²æ ‡è®°æ³•
1. å†™å±éšœ (Write-barrier)

é™ä½ä¸»çº¿ç¨‹å¤„ç†ä»»åŠ¡çš„ååé‡ (throughput)

</v-clicks>

<!--
è¦å®ç°å¢é‡æ‰§è¡Œï¼Œéœ€è¦æ»¡è¶³ä¸¤ç‚¹è¦æ±‚ï¼š

1.åƒåœ¾å›æ”¶å¯ä»¥è¢«éšæ—¶æš‚åœå’Œé‡å¯ï¼Œæš‚åœæ—¶éœ€è¦ä¿å­˜å½“æ—¶çš„æ‰«æç»“æœï¼Œç­‰ä¸‹ä¸€æ³¢åƒåœ¾å›æ”¶æ¥äº†ä¹‹åï¼Œæ‰èƒ½ç»§ç»­å¯åŠ¨ã€‚

2.åœ¨æš‚åœæœŸé—´ï¼Œè¢«æ ‡è®°å¥½çš„åƒåœ¾æ•°æ®å¦‚æœè¢« JavaScript ä»£ç ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆåƒåœ¾å›æ”¶å™¨éœ€è¦èƒ½å¤Ÿæ­£ç¡®åœ°å¤„ç†ã€‚


1.é»‘è‰²è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹è¢« GC Root å¼•ç”¨åˆ°äº†ï¼Œè€Œä¸”è¯¥èŠ‚ç‚¹çš„å­èŠ‚ç‚¹éƒ½å·²ç»æ ‡è®°å®Œæˆäº† ;

2.ç°è‰²è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹è¢« GC Root å¼•ç”¨åˆ°ï¼Œä½†å­èŠ‚ç‚¹è¿˜æ²¡è¢«åƒåœ¾å›æ”¶å™¨æ ‡è®°å¤„ç†ï¼Œä¹Ÿè¡¨æ˜ç›®å‰æ­£åœ¨å¤„ç†è¿™ä¸ªèŠ‚ç‚¹ï¼›(æš‚åœåGCå¤ä½åˆ°ç°è‰²åœ°)

3.ç™½è‰²è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹æ²¡æœ‰è¢«è®¿é—®åˆ°ï¼Œå¦‚æœåœ¨æœ¬è½®éå†ç»“æŸæ—¶è¿˜æ˜¯ç™½è‰²ï¼Œé‚£ä¹ˆè¿™å—æ•°æ®å°±ä¼šè¢«æ”¶å›ã€‚


å†™å±éšœ (Write-barrier) æœºåˆ¶å®ç°è¿™ä¸ªçº¦æŸæ¡ä»¶--ä¸èƒ½è®©é»‘è‰²èŠ‚ç‚¹æŒ‡å‘ç™½è‰²èŠ‚ç‚¹ã€‚æ‰€ä»¥åœ¨ V8 ä¸­ï¼Œæ¯æ¬¡æ‰§è¡Œå¦‚ window.a.b = valueçš„å†™æ“ä½œä¹‹åï¼ŒV8 ä¼šæ’å…¥å†™å±éšœä»£ç ï¼Œå¼ºåˆ¶å°† value è¿™å—å†…å­˜æ ‡è®°ä¸ºç°è‰²ã€‚
-->

---

## å¹¶å‘ (concurrent) å›æ”¶

<v-clicks>

![å¹¶å‘å›æ”¶](/concurrent.awebp)

- å½“ä¸»çº¿ç¨‹æ‰§è¡Œ JavaScript æ—¶ï¼Œå †ä¸­çš„å†…å®¹éšæ—¶éƒ½æœ‰å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œä»è€Œä½¿å¾—è¾…åŠ©çº¿ç¨‹ä¹‹å‰åšçš„å·¥ä½œå®Œå…¨æ— æ•ˆï¼›
- ä¸»çº¿ç¨‹å’Œè¾…åŠ©çº¿ç¨‹ææœ‰å¯èƒ½åœ¨åŒä¸€æ—¶é—´å»æ›´æ”¹åŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™å°±éœ€è¦é¢å¤–å®ç°è¯»å†™é”çš„ä¸€äº›åŠŸèƒ½äº†ã€‚

</v-clicks>

<!-- æ‰€è°“å¹¶å‘å›æ”¶ï¼Œæ˜¯æŒ‡ä¸»çº¿ç¨‹åœ¨æ‰§è¡Œ JavaScript çš„è¿‡ç¨‹ä¸­ï¼Œè¾…åŠ©çº¿ç¨‹èƒ½å¤Ÿåœ¨åå°å®Œæˆæ‰§è¡Œåƒåœ¾å›æ”¶çš„æ“ä½œã€‚ -->

---

## å‡ ç§å†…å­˜é—®é¢˜

<v-clicks>

1. å†…å­˜æ³„æ¼ (Memory leak)ï¼Œå®ƒä¼šå¯¼è‡´é¡µé¢çš„æ€§èƒ½è¶Šæ¥è¶Šå·®ï¼›
   - æ„å¤–å£°æ˜å…¨å±€å˜é‡
   - æ»¥ç”¨é—­åŒ…
   - "detached"èŠ‚ç‚¹
1. å†…å­˜è†¨èƒ€ (Memory bloat)ï¼Œå®ƒä¼šå¯¼è‡´é¡µé¢çš„æ€§èƒ½ä¼šä¸€ç›´å¾ˆå·®ï¼›
1. é¢‘ç¹åƒåœ¾å›æ”¶ï¼Œå®ƒä¼šå¯¼è‡´é¡µé¢å‡ºç°å»¶è¿Ÿæˆ–è€…ç»å¸¸æš‚åœã€‚

```bash
function strToArray(str) {
  let i = 0, len = str.length;
  let arr = new Uint16Array(str.length);
  for (; i < len; ++i) arr[i] = str.charCodeAt(i);
  return arr;
}
function foo() {
  let i = 0;
  let str = "test V8 GC";
  while (i++ < 1e5) strToArray(str);
}
foo();
```

è¿™æ®µä»£ç å°±ä¼šé¢‘ç¹åˆ›å»ºä¸´æ—¶å˜é‡ï¼Œè¿™ç§æ–¹å¼å¾ˆå¿«å°±ä¼šé€ æˆæ–°ç”Ÿä»£å†…å­˜å†…è£…æ»¡ï¼Œä»è€Œé¢‘ç¹è§¦å‘åƒåœ¾å›æ”¶ã€‚

</v-clicks>

<!-- ä¸ºäº†è§£å†³é¢‘ç¹çš„åƒåœ¾å›æ”¶çš„é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘å°†ä¸´æ—¶å˜é‡è®¾ç½®ä¸ºå…¨å±€å˜é‡ã€‚ -->
